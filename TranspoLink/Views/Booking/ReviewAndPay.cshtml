@model TranspoLink.Models.BookingVM
@using System.Globalization

@{
    var trip = Model.Trip;
    ViewBag.Title = "Review & Pay | " + (Model.Trip?.Route?.Origin ?? "N/A") + " ➝ " + (Model.Trip?.Route?.Destination ?? "N/A");
}

@section head {
    <link rel="stylesheet" href="/css/RNT.css" asp-append-version="true" />
    <link rel="stylesheet" href="/css/RAP.css" asp-append-version="true" />
}


<div class="stepper-header-container">
    <div class="stepper-header">
        <ol>
            <li class="active-step">
                <a asp-controller="Booking"
                   asp-action="Book"
                   asp-route-id="@Model.TripId"
                   style="text-decoration: none; color: inherit;">
                    1. Select seats
                </a>
            </li>
            <li class="current-step">2. Passenger Information</li>
            <li class="disabled-step">3.  Payment </li>
        </ol>
    </div>
</div>

<form method="post" asp-action="ReviewAndPay" id="reviewForm">
    @Html.AntiForgeryToken()
    <input type="hidden" asp-for="TripId" />

    <div class="booking-container rap-main-content">
        <div class="booking-left rap-left-column">

            <h3 class="section-title card-title">Contact details</h3>
            <div class="rnt-card form-section">

                <div class="form-group">
                    <input asp-for="ContactEmail" class="rnt-input" placeholder="Email ID *" />
                    <span asp-validation-for="ContactEmail" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <div class="input-group">
                        <span class="country-code">+60 (MY)</span>
                        <input asp-for="ContactPhone" class="rnt-input" placeholder="Phone *" />
                    </div>
                    <span asp-validation-for="ContactPhone" class="text-danger"></span>
                </div>
            </div>

            <h3 class="section-title card-title">Passenger details</h3>

            @for (int i = 0; i < Model.Passengers.Count; i++)
            {
                <div class="rnt-card passenger-card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h4>Passenger @(i + 1)</h4>
                        <span class="seat-info">Seat @Model.Passengers[i].SeatNumber</span>

                        <input type="hidden" asp-for="Passengers[i].SeatNumber" />
                    </div>

                    <div class="form-group">
                        <input asp-for="Passengers[i].Name" class="rnt-input" placeholder="Name *" />
                    </div>
                    <div class="form-group">
                        <input asp-for="Passengers[i].Age" type="number" class="rnt-input" placeholder="Age *" />
                    </div>
                </div>
            }

            <h3 class="section-title card-title">Travel Insurance</h3>
            <div class="rnt-card insurance-card">
                <div class="toggle-options">
                    <label class="toggle-option insurance-yes">
                        <input type="radio" asp-for="HasTravelInsurance" value="true" />
                        <div class="toggle-text option-content">
                            <p>Yes, Protect my trip at RM <span id="insurance-price">@Model.InsurancePrice.ToString("N2")</span> (per passenger)</p>
                        </div>
                    </label>
                    <label class="toggle-option insurance-no">
                        <input type="radio" asp-for="HasTravelInsurance" value="false" />
                        <div class="toggle-text option-content">
                            <h5>No, I would like to proceed without insurance</h5>
                        </div>
                    </label>
                </div>
            </div>

            <h3 class="section-title card-title">Boarding pass</h3>
            <div class="rnt-card boarding-pass-card">
                <p class="pass-info">Boarding pass & facility charges are collected on behalf of the terminal, redBus passes the fee amount on to them.</p>
                <div class="toggle-switch-container">
                    <span>Add Boarding Pass</span>
                    <label class="switch">
                        <input type="checkbox" asp-for="HasBoardingPass" id="hasBoardingPass" />
                        <span class="slider round"></span>
                    </label>
                </div>
                <p class="guarantee-cost">RM @Model.BoardingPassPrice.ToString("N2") x @Model.Passengers.Count pax (Facility Charge)</p>
                <p class="terms-note">
                    <a href="#" class="terms-link">Know More</a>
                </p>
            </div>

            

        </div>

        <div class="booking-right rap-right-column">
            <div class="rnt-card trip-summary-fixed price-summary-card">

                <div class="trip-info">
                    <h5 class="card-title">@trip.Route?.Origin → @trip.Route?.Destination</h5>

                    <div class="info-row">
                        <span class="info-label">Departure</span>
                        <span class="info-value">@trip.DepartureTime.ToString("dd MMM yyyy, HH:mm")</span>
                    </div>

                    <div class="info-row">
                        <span class="info-label">Base Price/Seat</span>
                        <span class="info-value price-per-seat" data-price="@Model.BasePricePerTicket.ToString("F2")">RM @Model.BasePricePerTicket.ToString("N2")</span>
                    </div>

                    <div class="info-row">
                        <span class="info-label">Selected Seats</span>
                        <span class="info-value">
                            @(string.Join(", ", Model.Passengers.Select(p => p.SeatNumber)))
                        </span>
                    </div>
                

                   

                    <div class="breakdown-total">
                        <span class="total-label">Total Amount</span>
                        <span class="total-value" id="finalTotal">RM @Model.FinalTotal.ToString("N2")</span>
                    </div>
                </div>

                <div class="pay-button-fixed">
                    <button type="submit" form="reviewForm" class="btn-rnt btn-rnt-danger pay-now-btn">
                        <span class="btn-text">Pay Now</span>
                        <span class="btn-amount">RM @Model.FinalTotal.ToString("N2")</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="booking-right rap-right-column">
        <div class="rnt-card trip-summary-fixed price-summary-card">

            <div class="fare-breakdown">
                <h4 class="breakdown-title">Fare Breakdown</h4>
                <div class="breakdown-row breakdown-row-base">
                    <span class="breakdown-label">Base Fare (<span id="fare-seats">@Model.Passengers.Count</span> seats)</span>
                    <span class="breakdown-value" id="fare-base">RM @Model.TotalBaseFare.ToString("N2")</span>
                </div>

                <div class="breakdown-row insurance-row" style="@(Model.HasTravelInsurance ? "" : "display:none;")">
                    <span class="breakdown-label">Insurance Fee</span>
                    <span class="breakdown-value" id="fare-insurance">RM @Model.TotalInsuranceFee.ToString("N2")</span>
                </div>

                <div class="breakdown-row refund-row" style="@(Model.HasRefundGuarantee ? "" : "display:none;")">
                    <span class="breakdown-label">Refund Guarantee</span>
                    <span class="breakdown-value" id="fare-refund">RM @Model.TotalRefundFee.ToString("N2")</span>
                </div>

                <div class="breakdown-row boarding-pass-row" style="@(Model.HasBoardingPass ? "" : "display:none;")">
                    <span class="breakdown-label">Boarding Pass Fee</span>
                    <span class="breakdown-value" id="fare-boardingpass">RM @Model.TotalBoardingPassFee.ToString("N2")</span>
                </div>

              
                
            </div>

            <div class="pay-button-fixed">
                <button type="submit" form="reviewForm" class="btn-rnt btn-rnt-danger pay-now-btn">
                    <span class="btn-text">Pay Now</span>
                    <span class="btn-amount">RM @Model.FinalTotal.ToString("N2")</span>
                </button>
            </div>
        </div>
    </div>
    
</form>

@section scripts {
    <script src="/js/jquery.min.js" asp-append-version="true"></script>
    <script src="/js/jquery.validate.min.js" asp-append-version="true"></script>
    <script src="/js/jquery.validate.unobtrusive.min.js" asp-append-version="true"></script>
    <script src="/js/RAP.js" asp-append-version="true"></script>

    <script>
        window.bookingData = {
            // ... (确保这些值是数字)
            basePricePerTicket: parseFloat('@Model.BasePricePerTicket.ToString("F2")'),
            insurancePrice: parseFloat('@Model.InsurancePrice.ToString("F2")'),
            refundGuaranteePrice: parseFloat('@Model.RefundGuaranteePrice.ToString("F2")'),
            boardingPassPrice: parseFloat('@Model.BoardingPassPrice.ToString("F2")'),
            passengerCount: @Model.Passengers.Count
        };
    </script>
}
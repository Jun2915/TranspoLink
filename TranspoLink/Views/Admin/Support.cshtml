@* *@
@{
    ViewBag.Title = "Support Chat";
    var activeUsers = ViewBag.ActiveUsers as IEnumerable<dynamic>;
}

@section head {
    <link rel="stylesheet" href="/css/admin.css" />
    <link rel="stylesheet" href="/css/chat.css" />
}

<div class="admin-container">
    <div class="admin-header">
        <h1>💬 Live Support Dashboard</h1>
    </div>

    <div class="admin-chat-layout">
        <div class="user-list-panel" id="userList">
            <div style="padding:15px; font-weight:bold; background:#f1f3f5;">Inbox</div>

            @if (activeUsers != null)
            {
                foreach (var u in activeUsers)
                {
                    <div class="chat-user-item" data-user="@u.Id" onclick="loadChatHistory('@u.Id', '@u.Name')">
                        <div style="font-weight:bold; font-size:14px;">@u.Name</div>
                        <div style="font-size:12px; color:#666;">@u.Id</div>
                    </div>
                }
            }
        </div>

        <div class="chat-main-panel">
            <div class="chat-header"><span id="chatTitle">Select a user</span></div>
            <div class="chat-messages" id="adminMessagesArea"></div>
            <div class="chat-input-area">
                <input type="text" id="adminInput" class="chat-input" placeholder="Type a reply..." disabled>
                <button id="adminSendBtn" class="chat-send-btn" disabled>➤</button>
            </div>
        </div>
    </div>
</div>

@section foot {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script>
        const conn = new signalR.HubConnectionBuilder().withUrl("/chatHub").withAutomaticReconnect().build();
        let activeUserId = null;

        // 1. Request Notification Permission
        if (Notification.permission !== "granted") Notification.requestPermission();

        conn.start();

        // 2. RECEIVE MESSAGE
        conn.on("ReceiveSupportMessage", (email, name, msg, time) => {
            // Add user to list if new
            if ($(`[data-user="${email}"]`).length === 0) {
                const html = `<div class="chat-user-item" data-user="${email}" onclick="loadChatHistory('${email}', '${name}')">
                                <div style="font-weight:bold; font-size:14px;">${name}</div>
                                <div style="font-size:12px; color:#666;">${email}</div>
                              </div>`;
                $('#userList').prepend(html);
            }

            if (activeUserId === email) {
                renderMessage("User", name, msg, time);
            } else {
                $(`[data-user="${email}"]`).css('background', '#ffebee'); // Highlight
                playNotification(name, msg);
            }
        });

        conn.on("ReceiveMyReply", (id, msg, time) => {
            if (id === activeUserId) renderMessage("Me", "Support", msg, time);
        });

        // 3. AJAX HISTORY (Fixes Offline)
        window.loadChatHistory = function(id, name) {
            activeUserId = id;
            $('#chatTitle').text(name);
            $('#adminInput').prop('disabled', false).focus();
            $('#adminSendBtn').prop('disabled', false);

            // Reset highlighting
            $('.chat-user-item').css('background', '');
            $(`[data-user="${id}"]`).css('background', '#eef2ff');

            // Load via Ajax
            $.get("/Admin/GetChatHistory?userId=" + encodeURIComponent(id), function(data) {
                $('#adminMessagesArea').empty();
                data.forEach(m => renderMessage(m.sender, m.name, m.text, m.time));
                scrollToBottom();
            });
        };

        // 4. RENDER MESSAGE (Layout Fix)
        function renderMessage(type, name, text, time) {
            const isMe = type === "Me";
            const cls = isMe ? "msg-sent" : "msg-received";
            const nameHtml = isMe ? "" : `<div class="msg-sender-name">${name}</div>`;

            const html = `
                <div class="message-bubble ${cls}">
                    ${nameHtml}
                    <div class="msg-text-content">${text}</div>
                    <div class="msg-meta">${time}</div>
                </div>`;
            $('#adminMessagesArea').append(html);
            scrollToBottom();
        }

        function scrollToBottom() {
            const d = $('#adminMessagesArea'); d.scrollTop(d[0].scrollHeight);
        }

        // 5. SEND REPLY
        $('#adminSendBtn').click(() => send());
        $('#adminInput').keypress(e => { if(e.which==13) send(); });

        function send() {
            const val = $('#adminInput').val().trim();
            if(val && activeUserId) {
                conn.invoke("ReplyToUser", activeUserId, val);
                $('#adminInput').val('');
            }
        }

        // 6. NOTIFICATION
        function playNotification(user, text) {
            try {
                // Sound
                new Audio('https://codeskulptor-demos.commondatastorage.googleapis.com/pang/pop.mp3').play().catch(()=>{});
                // Desktop Alert
                if (Notification.permission === "granted" && document.hidden) {
                    new Notification(`New message from ${user}`, { body: text, icon: "/images/shortcut_icon.png" });
                }
            } catch(e){}
        }
    </script>
}